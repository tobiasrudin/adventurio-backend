---
Transform: "AWS::Serverless-2016-10-31"
Parameters:
  Stage:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - prod
    Description: Enter 'dev' or 'prod'. Default 'dev'.
Globals:
  Function:
    Environment:
      Variables:
        TEST_ENV: false
        GAMES_TABLE: !Ref GamesTable
Resources:
  AdventurioApiGateway:
    Type: AWS::Serverless::Api
    Properties:
      StageName: !Sub ${Stage}
      DefinitionUri: ./specs/openapi.yaml
      Variables:
        PutGameFunction: !Ref PutGameFunction
        GetGameFunction: !Ref GetGameFunction
  PutGameFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "put-game-function-${Stage}"
      Runtime: python3.7
      Handler: index.handler
      CodeUri: ./lambda/put-game/
      Layers:
        - !Ref AdventurioGamesCommonFiles
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref GamesTable
      Events:
        PostPetApi:
          Type: Api
          Properties:
            RestApiId: !Ref AdventurioApiGateway
            Path: /games/{gameId}
            Method: PUT
  GetGameFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "get-game-function-${Stage}"
      Runtime: python3.7
      Handler: index.handler
      CodeUri: ./lambda/get-game/
      Layers:
        - !Ref AdventurioGamesCommonFiles
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref GamesTable
      Events:
        PostPetApi:
          Type: Api
          Properties:
            RestApiId: !Ref AdventurioApiGateway
            Path: /games/{gameId}
            Method: GET
  AdventurioGamesCommonFiles:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: adventurio-app-common-files
      Description: Common files for adventurio app
      ContentUri: ./lambda/common/
      CompatibleRuntimes:
        - python3.7
      RetentionPolicy: Retain
  GamesTable:
    Type: AWS::Serverless::SimpleTable
    Properties:
      TableName: !Sub "adventurio-games-${Stage}"
      PrimaryKey:
        Name: id
        Type: String
